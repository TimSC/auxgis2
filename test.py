#ogr2ogr -f KML output.kml input.shp

#0 kml
#1 Document
#2 Folder
#3 name
#3 Placemark
#4 name
#4 ExtendedData
#5 SchemaData
#6 SimpleData

import bz2, json, os
import xml.parsers.expat
from shapely.geometry import Polygon, LineString, LinearRing, Point, MultiPolygon, MultiPoint
from shapely.geometry.collection import GeometryCollection
import shapely.wkt
from django.contrib.gis.geos import GEOSGeometry
from django.db import transaction

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "auxgis2.settings")
import django
django.setup()
from records.models import *
import django.core.exceptions as dex
import datetime
from django.contrib.auth.models import User
from django.db import IntegrityError
import shapely.wkt as wkt

def test(shapeWkt):

	importTime = datetime.datetime.now()
	importUser = User.objects.all()[0]

	try:
		ds = DatasetSeries.objects.get(name="Scheduled Monuments (England)")
	except dex.ObjectDoesNotExist:
		ds = DatasetSeries(name="Scheduled Monuments (England)",
			description="",
			license="")
		ds.save()

	shape = wkt.loads(shapeWkt)
	externalId = "00001"
	placeName = "foobar"
	rp = shape.representative_point()

	pos = GEOSGeometry(str(rp), srid=4326)
	rec2 = Record(currentName = placeName, 
		currentPosition = pos,
		datasetSeries = ds,
		externalId = externalId)
	rec2.save()

	newAnnot = RecordNameEdit(record = rec2,
		data = placeName, 
		timestamp = importTime,
		user = importUser)
	newAnnot.save()

	newAnnot = RecordPositionEdit(record = rec2,
		data = pos, 
		timestamp = importTime,
		user = importUser)
	newAnnot.save()

	if not shape.is_valid:
		shape = shape.buffer(0.0)
	shape2 = GeometryCollection([shape])
	shape3 = GEOSGeometry(buffer(shape2.wkb), srid=4326)
	print shape3.valid
	print shape3.wkt

	newAnnot = RecordShapeEdit(record = rec2,
		data = shape3, 
		timestamp = importTime,
		user = importUser)
	newAnnot.save()
			
if __name__=="__main__":
	print "Good shape"

	goodShape="POLYGON ((0.004585821432403 53.39205655445362, 0.004370524051853 53.39197386424815, 0.003511999412435 53.39224718406162, 0.003334269156126 53.39230564512001, 0.003010761561655 53.39244359770373, 0.002313077441331 53.39273886079805, 0.002153264778766 53.3928494141358, 0.002098473352319 53.39289040220098, 0.001975450131408 53.39301575633081, 0.001571912175901 53.39342627983574, 0.00144845213223 53.39354238985806, 0.001054429533822 53.39382638644516, 0.000660690765872 53.39411654416967, 0.000258658810006 53.3944499832029, -0.000208743564432 53.39485788447784, -0.000230623648264 53.39490287808773, -0.000236528103555 53.39494760407232, -0.000210152629556 53.39499816331232, -0.000134789640903 53.39507021540287, 0.0000 53.39512930610134, 0.0001 53.39519086239132, 0.000320701021055 53.39528731045475, 0.000440541032034 53.39534108611749, 0.000495476965256 53.39537522708896, 0.000526128004445 53.39540340096636, 0.000552505095391 53.39545396900132, 0.00056354800768 53.39551912431292, 0.000561917344505 53.39565462410584, 0.001403023462806 53.39573616267051, 0.001776075560191 53.39578728279303, 0.002238095515083 53.39585922310508, 0.002415730663242 53.39589449667334, 0.00262892046244 53.39594829555955, 0.002759136797677 53.39599552084307, 0.003148451411336 53.39571166071373, 0.003852256735541 53.39519780287833, 0.004239121351319 53.39491876291179, 0.0048580524367 53.39447166424996, 0.00570113015205 53.39385822744637, 0.006098176439091 53.39356945364467, 0.006789195134597 53.39306853168554, 0.006903507578287 53.39298848546464, 0.006452162455299 53.39282038704182, 0.006147262062949 53.39269606225199, 0.005531717833986 53.39243518140811, 0.005205915002175 53.39230503820097, 0.004585821432403 53.39205655445362))"

	test(goodShape)

	print "Bad shape"

	badShape="POLYGON ((0.004585821432403 53.39205655445362, 0.004370524051853 53.39197386424815, 0.003511999412435 53.39224718406162, 0.003334269156126 53.39230564512001, 0.003010761561655 53.39244359770373, 0.002313077441331 53.39273886079805, 0.002153264778766 53.3928494141358, 0.002098473352319 53.39289040220098, 0.001975450131408 53.39301575633081, 0.001571912175901 53.39342627983574, 0.00144845213223 53.39354238985806, 0.001054429533822 53.39382638644516, 0.000660690765872 53.39411654416967, 0.000258658810006 53.3944499832029, -0.000208743564432 53.39485788447784, -0.000230623648264 53.39490287808773, -0.000236528103555 53.39494760407232, -0.000210152629556 53.39499816331232, -0.000134789640903 53.39507021540287, 0.0000 53.39512930610134, 0.00001 53.39519086239132, 0.000320701021055 53.39528731045475, 0.000440541032034 53.39534108611749, 0.000495476965256 53.39537522708896, 0.000526128004445 53.39540340096636, 0.000552505095391 53.39545396900132, 0.00056354800768 53.39551912431292, 0.000561917344505 53.39565462410584, 0.001403023462806 53.39573616267051, 0.001776075560191 53.39578728279303, 0.002238095515083 53.39585922310508, 0.002415730663242 53.39589449667334, 0.00262892046244 53.39594829555955, 0.002759136797677 53.39599552084307, 0.003148451411336 53.39571166071373, 0.003852256735541 53.39519780287833, 0.004239121351319 53.39491876291179, 0.0048580524367 53.39447166424996, 0.00570113015205 53.39385822744637, 0.006098176439091 53.39356945364467, 0.006789195134597 53.39306853168554, 0.006903507578287 53.39298848546464, 0.006452162455299 53.39282038704182, 0.006147262062949 53.39269606225199, 0.005531717833986 53.39243518140811, 0.005205915002175 53.39230503820097, 0.004585821432403 53.39205655445362))"

	test(badShape)

